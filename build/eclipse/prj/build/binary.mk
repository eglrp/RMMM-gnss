#
# include common defs
#
include ../build/build.mk

#
# definitions for secondary loader images
#
SECLOADER_IMAGE26:=${SECLOADER_SUPPORT_FOLDER}/${MOD_CORE}_boot_${MOD_LOAD_RGN}_26MHz.${MOD_BINEXT}
SECLOADER_IMAGE48:=${SECLOADER_SUPPORT_FOLDER}/${MOD_CORE}_boot_${MOD_LOAD_RGN}_48MHz.${MOD_BINEXT}
SECLOADER_IMAGE55:=${SECLOADER_SUPPORT_FOLDER}/${MOD_CORE}_boot_${MOD_LOAD_RGN}_55MHz.${MOD_BINEXT}

#
# definitions for binary images MOD_COREs
#
BINIMG_PLATFORM:=$(call MK_UPPER,${MOD_CORE})
BINIMG_EXTRA:=$(if $(findstring ${MOD_LOAD_RGN},nor),_NOR)

ifeq (${PROJ_MOD_EXTRA},dr)
BINIMG_VER:=$(shell @${MK_BUSYBOX} echo ${VERSION_BINARY_DR} | @${MK_BUSYBOX} sed "s/\./_/g" )${VERSION_SUFFIX}
BINIMG_DEF_CFG:=${SECLOADER_SUPPORT_FOLDER}/fwcfg_bin_dr_default.txt
else
BINIMG_VER:=$(shell @${MK_BUSYBOX} echo ${VERSION_BINARY} | @${MK_BUSYBOX} sed "s/\./_/g" )${VERSION_SUFFIX}
BINIMG_DEF_CFG:=${SECLOADER_SUPPORT_FOLDER}/fwcfg_bin_default.txt
endif

BINIMG_FOLDER:=${COMMON_BINDIR}/${BINIMG_PLATFORM}_BINARY_IMAGE_v${BINIMG_VER}${BINIMG_EXTRA}
BINIMG_FILENAME:=${BINIMG_PLATFORM}_${BINIMG_VER}${BINIMG_EXTRA}

BINIMG_FILENAME_UPG26:=${BINIMG_FOLDER}/${BINIMG_FILENAME}_${MOD_UPGEXT}26.${MOD_BINEXT}
BINIMG_FILENAME_UPG48:=${BINIMG_FOLDER}/${BINIMG_FILENAME}_${MOD_UPGEXT}48.${MOD_BINEXT}
BINIMG_FILENAME_UPG55:=${BINIMG_FOLDER}/${BINIMG_FILENAME}_${MOD_UPGEXT}55.${MOD_BINEXT}
BINIMG_FILENAME_BOOT26:=${BINIMG_FOLDER}/${BINIMG_FILENAME}_${MOD_BOOTEXT}26.${MOD_BINEXT}
BINIMG_FILENAME_BOOT48:=${BINIMG_FOLDER}/${BINIMG_FILENAME}_${MOD_BOOTEXT}48.${MOD_BINEXT}
BINIMG_FILENAME_BOOT55:=${BINIMG_FOLDER}/${BINIMG_FILENAME}_${MOD_BOOTEXT}55.${MOD_BINEXT}
BINIMG_FILENAME_EVB_BT_UPG:=${BINIMG_FOLDER}/${BINIMG_FILENAME}_EVB-T3_BT_${MOD_UPGEXT}.${MOD_BINEXT}
BINIMG_FILENAME_EVB_USB_UPG:=${BINIMG_FOLDER}/${BINIMG_FILENAME}_EVB-T3_USB_${MOD_UPGEXT}.${MOD_BINEXT}

${BINIMG_FOLDER}: ${PROJ_COMMONMK}
	$(call MK_MKDIR,"$(call MK_PATHTOWIN,$@)")

.SECONDARY: postbuildbinimg

postbuildbinimg: ${TARGET_DEST_FILENAME_BIN} ${BINIMG_FOLDER}
	$(info Creating binaries in folder ${BINIMG_FOLDER})
	$(call MK_RMFILE,"${BINIMG_FILENAME_BOOT26}" "${BINIMG_FILENAME_BOOT48}" "${BINIMG_FILENAME_BOOT55}" "${BINIMG_FILENAME_UPG26}" "${BINIMG_FILENAME_UPG48}" "${BINIMG_FILENAME_UPG55}")
	$(call MK_CP,"${TARGET_DEST_FILENAME_BIN}","${BINIMG_FILENAME_UPG}_temp")
	$(call MK_FWCONFIG,"${BINIMG_FILENAME_UPG}_temp","${BINIMG_FILENAME_UPG}_def","${BINIMG_DEF_CFG}")
	$(call MK_CP,"${BINIMG_FILENAME_UPG}_def","${BINIMG_FILENAME_UPG26}")
	$(call MK_FWCONFIG,"${BINIMG_FILENAME_UPG}_def","${BINIMG_FILENAME_UPG48}","${SECLOADER_SUPPORT_FOLDER}/fwcfg_bin_48MHz.txt")
	$(call MK_FWCONFIG,"${BINIMG_FILENAME_UPG}_def","${BINIMG_FILENAME_UPG55}","${SECLOADER_SUPPORT_FOLDER}/fwcfg_bin_55MHz.txt")
	$(call MK_FWCONFIG,"${BINIMG_FILENAME_UPG}_def","${BINIMG_FILENAME_EVB_BT_UPG}","${SECLOADER_SUPPORT_FOLDER}/fwcfg_bin_evb_bt.txt")
	$(call MK_FWCONFIG,"${BINIMG_FILENAME_UPG}_def","${BINIMG_FILENAME_EVB_USB_UPG}","${SECLOADER_SUPPORT_FOLDER}/fwcfg_bin_evb_usb.txt")
	$(call MK_RMFILE,"${BINIMG_FILENAME_UPG}_def")
	$(call MK_RMFILE,"${BINIMG_FILENAME_UPG}_temp")
	$(call MK_CAT,"${SECLOADER_IMAGE26}" "${SECLOADER_CODEVAL}" "${BINIMG_FILENAME_UPG26}","${BINIMG_FILENAME_BOOT26}")
	$(call MK_FWCHECKCRC,"${BINIMG_FILENAME_BOOT26}")
	$(call MK_CAT,"${SECLOADER_IMAGE48}" "${SECLOADER_CODEVAL}" "${BINIMG_FILENAME_UPG48}","${BINIMG_FILENAME_BOOT48}")
	$(call MK_FWCHECKCRC,"${BINIMG_FILENAME_BOOT48}")
	$(call MK_CAT,"${SECLOADER_IMAGE55}" "${SECLOADER_CODEVAL}" "${BINIMG_FILENAME_UPG55}","${BINIMG_FILENAME_BOOT55}")
